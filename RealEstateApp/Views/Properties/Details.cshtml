@model RealEstateApp.Models.Property
@using Microsoft.AspNetCore.Identity

@{
    ViewData["Title"] = "Property Details";
}

<div class="container mt-5 mb-5">
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show mb-4" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i>
            <strong>Success!</strong> @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    <div class="card shadow-lg border-0 overflow-hidden">

        <div class="row g-0 align-items-center">

            <div class="col-lg-7 bg-light">
                <div id="propertyCarousel" class="carousel slide" data-bs-ride="carousel">
                    <div class="carousel-inner">
                        @if (Model.Images != null && Model.Images.Any())
                        {
                            int i = 0;
                            foreach (var img in Model.Images)
                            {
                                <div class="carousel-item @(i == 0 ? "active" : "")">
                                    <img src="/images/@img.Url" class="d-block w-100"
                                         style="height: 600px; object-fit: cover;"
                                         alt="Property Image">
                                </div>
                                i++;
                            }
                        }
                        else
                        {
                            <div class="carousel-item active">
                                <img src="/images/@Model.ImageUrl" class="d-block w-100"
                                     style="height: 600px; object-fit: cover;"
                                     alt="Cover Image">
                            </div>
                        }
                    </div>
                    <button class="carousel-control-prev" type="button" data-bs-target="#propertyCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon bg-dark rounded-circle p-3" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#propertyCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon bg-dark rounded-circle p-3" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>

            <div class="col-lg-5">
                <div class="card-body p-4 p-lg-5">

                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h2 class="fw-bold text-dark mb-0">@Model.Title</h2>
                        @if (Model.IsForSale)
                        {
                            <span class="badge bg-success fs-6">For Sale</span>
                        }
                        else
                        {
                            <span class="badge bg-info text-dark fs-6">For Rent</span>
                        }
                    </div>

                    <p class="text-muted mb-4"><i class="bi bi-geo-alt-fill text-danger"></i> @Model.Address</p>

                    <h3 class="text-primary fw-bold mb-4">
                        NRP @Model.Price.ToString("N0")
                    </h3>

                    <div class="row text-center mb-4 g-2">
                        <div class="col-4">
                            <div class="p-2 border rounded bg-light">
                                <i class="bi bi-layout-sidebar fs-4 text-secondary"></i>
                                <div class="small fw-bold">@Model.Bedrooms Beds</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 border rounded bg-light">
                                <i class="bi bi-droplet-fill fs-4 text-primary"></i>
                                <div class="small fw-bold">@Model.Bathrooms Baths</div>
                            </div>
                        </div>
                    </div>

                    <h6 class="fw-bold text-uppercase small text-muted">Description</h6>
                    <div class="mb-4 border rounded p-3 bg-light" style="max-height: 150px; overflow-y: auto;">
                        <p class="text-secondary mb-0 small">
                            @(!string.IsNullOrEmpty(Model.Description) ? Model.Description : "No description provided.")
                        </p>
                    </div>

                    <div class="d-flex align-items-center mb-4 p-3 border rounded shadow-sm bg-white">
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 50px; height: 50px;">
                            <i class="bi bi-person-fill fs-3"></i>
                        </div>
                        <div>
                            <div class="small text-muted text-uppercase fw-bold" style="font-size: 0.75rem;">Listed By</div>
                            <h5 class="mb-0 fw-bold text-dark">@Model.AgentName</h5>
                            <div class="small text-secondary mt-1">
                                <i class="bi bi-telephone-fill text-success me-1"></i> @Model.AgentPhone <br />
                                <i class="bi bi-envelope-fill text-primary me-1"></i> @Model.AgentEmail
                            </div>
                        </div>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-dark btn-lg" data-bs-toggle="modal" data-bs-target="#inquiryModal">
                            <i class="bi bi-envelope-fill"></i> Send Message
                        </button>

                        <form asp-controller="UserPanel" asp-action="ToggleSave" method="post">
                            <input type="hidden" name="propertyId" value="@Model.Id" />
                            @if (ViewBag.IsSaved == true)
                            {
                                <button type="submit" class="btn btn-danger w-100">
                                    <i class="bi bi-heart-fill"></i> Saved to Favorites
                                </button>
                            }
                            else
                            {
                                <button type="submit" class="btn btn-outline-danger w-100">
                                    <i class="bi bi-heart"></i> Save to Favorites
                                </button>
                            }
                        </form>

                        @if (User.IsInRole("Admin"))
                        {
                            <div class="mt-3 pt-3 border-top d-flex gap-2">
                                <a asp-action="Edit" asp-route-id="@Model.Id" class="btn btn-warning flex-fill">Edit</a>
                                <a asp-action="Delete" asp-route-id="@Model.Id" class="btn btn-danger flex-fill">Delete</a>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div class="card mt-4 border-0 shadow-sm bg-light">
        <div class="card-body">
            <h5 class="fw-bold text-dark mb-3">
                <i class="bi bi-calculator"></i> Mortgage Calculator
            </h5>

            <form id="mortgageForm">
                <div class="mb-2">
                    <label class="small text-muted fw-bold">Property Price (NRP)</label>
                    <input type="number" id="totalAmount" class="form-control" value="@Model.Price" readonly>
                </div>

                <div class="row">
                    <div class="col-6 mb-2">
                        <label class="small text-muted fw-bold">Down Payment (20%)</label>
                        <input type="number" id="downPayment" class="form-control" value="@(Model.Price * 0.2M)">
                    </div>

                    <div class="col-6 mb-2">
                        <label class="small text-muted fw-bold">Interest Rate (%)</label>
                        <input type="number" id="interestRate" class="form-control" value="10" step="0.1">
                    </div>
                </div>

                <div class="mb-3">
                    <label class="small text-muted fw-bold">Loan Duration (Years)</label>
                    <input type="range" class="form-range" id="loanYears" min="1" max="30" step="1" value="20" oninput="updateYearLabel(this.value)">
                    <div class="text-end small text-secondary"><span id="yearLabel">20</span> Years</div>
                </div>

                <hr class="my-2">

                <div class="d-flex justify-content-between align-items-center">
                    <span class="text-secondary fw-bold">Monthly Payment:</span>
                    <span class="text-primary fw-bolder fs-4" id="monthlyPayment">
                        ---
                    </span>
                </div>
            </form>
        </div>
    </div>
</div>

@if (ViewBag.SimilarProperties != null && ((List<RealEstateApp.Models.Property>)ViewBag.SimilarProperties).Count > 0)
{
    <div class="container mt-5 mb-5">
        <hr class="mb-5" />
        <h3 class="fw-bold mb-4">You Might Also Like</h3>

        <div class="row">
            @foreach (var item in (List<RealEstateApp.Models.Property>)ViewBag.SimilarProperties)
            {
                <div class="col-md-4 mb-4">
                    <div class="card h-100 shadow-sm border-0">
                        <div class="position-relative">
                            @if (!string.IsNullOrEmpty(item.ImageUrl))
                            {
                                <img src="/images/@item.ImageUrl" class="card-img-top" style="height: 200px; object-fit: cover;" alt="House">
                            }
                            else
                            {
                                <img src="https://via.placeholder.com/400x200" class="card-img-top" alt="No Image">
                            }

                            <div class="position-absolute top-0 end-0 p-2">
                                @if (item.IsForSale)
                                {
                                    <span class="badge bg-success">For Sale</span>
                                }
                                else
                                {
                                    <span class="badge bg-info text-dark">For Rent</span>
                                }
                            </div>
                        </div>

                        <div class="card-body">
                            <h5 class="card-title fw-bold text-truncate">@item.Title</h5>
                            <h6 class="text-primary fw-bold">NRP @item.Price.ToString("N0")</h6>
                            <p class="small text-muted mb-2 text-truncate"><i class="bi bi-geo-alt"></i> @item.Address</p>

                            <div class="d-flex justify-content-between small text-secondary mt-3">
                                <span><i class="bi bi-layout-sidebar"></i> @item.Bedrooms Bed</span>
                                <span><i class="bi bi-droplet-fill"></i> @item.Bathrooms Bath</span>
                            </div>

                            <div class="d-grid mt-3">
                                <a asp-action="Details" asp-route-id="@item.Id" class="btn btn-outline-primary btn-sm">View Details</a>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </div>


}


  <div class="mt-4">
        <a asp-action="Index" class="text-decoration-none text-secondary">
            <i class="bi bi-arrow-left"></i> Back to Listings
        </a>
    </div>


@* ### Step 2: Add the JavaScript Logic
Scroll to the very bottom of `Details.cshtml`. Add this script section below everything else (outside the main `divs`).

This script runs the math formula: `M = P [ i(1 + i)^n ] / [ (1 + i)^n – 1 ]`

```html *@

<script>
    // Run calculation on load
    document.addEventListener("DOMContentLoaded", function() {
        calculateMortgage();
    });

    // Listen for any changes in the inputs
    const inputs = document.querySelectorAll('#mortgageForm input');
    inputs.forEach(input => {
        input.addEventListener('input', calculateMortgage);
    });

    function updateYearLabel(val) {
        document.getElementById('yearLabel').innerText = val;
        calculateMortgage();
    }

    function calculateMortgage() {
        // 1. Get Values
        const price = parseFloat(document.getElementById('totalAmount').value) || 0;
        const downPayment = parseFloat(document.getElementById('downPayment').value) || 0;
        const interestRate = parseFloat(document.getElementById('interestRate').value) || 0;
        const years = parseFloat(document.getElementById('loanYears').value) || 0;

        // 2. Calculate Principal (Loan Amount)
        const principal = price - downPayment;

        // 3. Calculate Monthly Rate & Number of Payments
        // Rate is percentage / 100 / 12 months
        const monthlyRate = (interestRate / 100) / 12;
        const numberOfPayments = years * 12;

        // 4. Mortgage Formula
        let monthlyPayment = 0;

        if (interestRate === 0) {
            // If 0% interest, simple division
            monthlyPayment = principal / numberOfPayments;
        } else {
            // Standard formula
            monthlyPayment = principal * (monthlyRate * Math.pow(1 + monthlyRate, numberOfPayments)) /
                (Math.pow(1 + monthlyRate, numberOfPayments) - 1);
        }

        // 5. Update Display (Format as NRP currency)
        if (isFinite(monthlyPayment) && monthlyPayment > 0) {
            document.getElementById('monthlyPayment').innerText =
                "NRP " + monthlyPayment.toLocaleString('en-US', { maximumFractionDigits: 0 });
        } else {
            document.getElementById('monthlyPayment').innerText = "---";
        }
    }
</script>


<div class="modal fade" id="inquiryModal" tabindex="-1" aria-labelledby="inquiryModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Contact @Model.AgentName</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form asp-controller="Properties" asp-action="SendInquiry" method="post">
                <div class="modal-body">
                    <div class="alert alert-light border d-flex align-items-center mb-3">
                        <i class="bi bi-telephone-fill fs-4 me-3 text-success"></i>
                        <div>
                            <strong>Call Agent:</strong><br>
                            <a href="tel:@Model.AgentPhone" class="text-decoration-none text-dark fw-bold">@Model.AgentPhone</a>
                        </div>
                    </div>
                    <p class="small text-muted">Or send a message below:</p>
                    <input type="hidden" name="propertyId" value="@Model.Id" />
                    <div class="mb-3">
                        <label class="form-label">Your Email</label>
                        <input type="email" class="form-control" name="userEmail" required
                               value="@(User.Identity.IsAuthenticated? User.Identity.Name : "")">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Message</label>
                        <textarea class="form-control" name="message" rows="3">Hi, I am interested in @Model.Title. Please contact me.</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Message</button>
                </div>
            </form>
        </div>
    </div>
</div>